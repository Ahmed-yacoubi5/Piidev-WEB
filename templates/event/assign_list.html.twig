{% extends 'base.html.twig' %}

{% block title %}Assign Sponsors{% endblock %}

{% block body %}
<div class="container-xxl flex-grow-1 container-p-y">
  <h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">Events /</span> Assign Sponsors
  </h4>

  <div class="card mb-4">
    <h5 class="card-header">Assign Sponsors to Event: </h5>
    <div class="card-body">
      <form id="assignSponsorsForm" class="row">
        {% for sponsor in sponsors %}
          <div class="col-md-4 mb-3">
            <div class="form-check">
              <input class="form-check-input"
                     type="checkbox"
                     value="{{ sponsor.id }}"
                     id="sponsorCheck{{ sponsor.id }}"
                     name="sponsorIds[]"
                     {% if event.sponsors.contains(sponsor) %}checked{% endif %}>
              <label class="form-check-label" for="sponsorCheck{{ sponsor.id }}">
                {{ sponsor.name }}
              </label>
            </div>
          </div>
        {% endfor %}

        <div class="col-12 mt-4">
          <button type="submit" class="btn btn-primary">Assign Sponsors</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% if sponsors is empty %}
  <p class="text-muted">No sponsors assigned yet.</p>
{% else %}
  <div class="d-flex flex-wrap gap-2">
    {% for sponsor in sponsors %}
      <div class="badge bg-label-primary d-flex align-items-center">
        <i class="bx bx-user me-1"></i> {{ sponsor.name }}
        <button
          class="btn btn-sm btn-link text-danger ms-2 p-0"
          onclick="removeSponsor({{ sponsor.id }})"
          title="Remove sponsor"
        >
          <i class="bx bx-x"></i>
        </button>
      </div>
    {% endfor %}
  </div>
{% endif %}
<script>
document.getElementById('assignSponsorsForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const checkboxes = document.querySelectorAll('input[name="sponsorIds[]"]:checked');
  const sponsorIds = Array.from(checkboxes).map(cb => cb.value);

  fetch('{{ path("app_event_assign_sponsors", { id: event.id }) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ sponsorIds })
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    }
    throw new Error('Something went wrong');
  })
  .then(data => {
    alert(data.message);
    window.location.href = '{{ path("event_list") }}'; // Redirect back to list or wherever you like
  })
  .catch(error => {
    alert('Error: ' + error.message);
  });
});

</script>
{% endblock %}
